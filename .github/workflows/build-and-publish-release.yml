name: Build and publish Docker image

on:
  release:
    types: [published]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Log in to Docker registry
      run: |
        echo ${{ secrets.DOCKER_PASSWORD }} \
          | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
    - name: Build Docker image
      run: |
        docker build -t plantuml:latest . \
          --build-arg "version=${GITHUB_REF##*/}"
    - name: Run test
      run: |
        docker run --rm -v $(pwd)/test:/data plantuml sequence.puml
        compare test/sequence.png test/expected-sequence.png -compose src test/sequence-diff.png
    - name: Upload test result
      uses: actions/upload-artifact@v2
      with:
        name: sequence-diff
        path: test/sequence-diff.png
    - name: Build version info
      run: |
        docker run --rm -v $(pwd)/test:/data plantuml version.puml
    - name: Upload version info
      uses: actions/upload-artifact@v2
      with:
        name: version
        path: test/version.png
    - name: Tag Docker image
      run: |
        docker tag plantuml:latest dstockhammer/plantuml:latest
        docker tag plantuml:latest dstockhammer/plantuml:${GITHUB_REF##*/}
    - name: Push Docker images
      run: |
        docker push dstockhammer/plantuml:${GITHUB_REF##*/}
        docker push dstockhammer/plantuml:latest
    - name: Upload version info as release asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: test/version.png
        asset_name: version.png
        asset_content_type: image/png
